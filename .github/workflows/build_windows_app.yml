on:
  push:
    branches: [ "github_action_test" ]
    paths-ignore:
      - 'README.md'  # 忽略对README.md的更改


jobs:
  build:
    permissions:
      contents: write
    if: github.actor != 'github-actions[bot]'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest']

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: 3.11

    - run: pip install -r requirements.txt
    - run: python build.py
    # Optionally verify that it works (provided that it does not need user interaction)
    - uses: actions/upload-artifact@v2
      with:
        name: BlenderExtensionManager_win
        path: dist/*

    # Get the artifact download URL
    # Get the artifact download URL using PowerShell
    - name: Get Artifact Download URL
      id: get-download-url
      shell: pwsh
      run: |
        $headers = @{
          Accept = "application/vnd.github.v3+json"
        }
        $repo = "${{ github.repository }}"
        $response = Invoke-RestMethod -Uri "https://api.github.com/repos/$repo/actions/artifacts" -Headers $headers
        $artifact = $response.artifacts | Where-Object { $_.name -eq "BlenderExtensionManager_win" } | Select-Object -First 1
        $artifact_id = $artifact.id
        $download_url = "https://github.com/$repo/actions/runs/${{ github.run_id }}/artifacts/$artifact_id"
        Write-Output "::set-output name=download_url::$download_url"
    # Update README with the artifact download link
    - name: Update README
      shell: bash
      run: |
        DOWNLOAD_URL="${{ steps.get-download-url.outputs.download_url }}"
        sed -i "s|PLACEHOLDER_FOR_DOWNLOAD_LINK|${DOWNLOAD_URL}|" README.md

    # Commit README changes
    - name: Commit README changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add README.md
        git commit -m 'Update download link in README'
        git push